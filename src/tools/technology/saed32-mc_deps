#!/bin/bash

unset output
unset family
unset macro
while [[ "$1" != "" ]]
do
    case "$1" in
    -o) output="$2"; shift;;
    --family) family="$2"; shift;;
    --macro) macro="$2"; shift;;
    *) echo "unknown argument $1"; exit 1;;
    esac
    shift
done

if [[ "$output" == "" ]]
then
    echo "Provide an output file with -o"
    exit 1
fi

cat > "$output" << EOF
# autogenerated by $0
ifeq (\$(CCOMPILER_VERSION),)
\$(error Custom Compiler is required to run the SAED32 macro compiler)
endif

CCOMPILER_HOME ?= \$(SYNOPSYS_HOME)/customcompiler/\$(CCOMPILER_VERSION)
CCOMPILER_BIN ?= \$(CCOMPILER_HOME)/linux64/platform/bin/custom_compiler
ifeq (\$(wildcard \$(CCOMPILER_BIN)),)
\$(error Unable to find cdesigner at \$(CCOMPILER_BIN))
endif

OA2LEF_BIN ?= \$(CCOMPILER_HOME)/amd64/OA/bin/oa2lef
ifeq (\$(wildcard \$(OA2LEF_BIN)),)
\$(error Unable to find oa2lef at \$(OA2LEF_BIN))
endif

OBJ_MAP_SYN_FILES += \$(OBJ_TECH_DIR)/generated/${family}/${macro}/output/${macro}.db
\$(OBJ_TECH_DIR)/generated/${family}/${macro}/output/${macro}.db: \$(OBJ_TECH_DIR)/generated/${family}/${macro}/stamp
	@mkdir -p \$(dir \$@)
	cp \$(OBJ_TECH_DIR)/generated/${family}/${macro}/NLDM/$(echo "${macro}" | tr [:upper:] [:lower:])_*_tt0p9v25c.lib \$@

OBJ_MAP_SIM_MACRO_FILES += \$(OBJ_TECH_DIR)/generated/${family}/${macro}/output/${macro}.v
\$(OBJ_TECH_DIR)/generated/${family}/${macro}/output/${macro}.v: \$(OBJ_TECH_DIR)/generated/${family}/${macro}/stamp
	@mkdir -p \$(dir \$@)
	cp \$(OBJ_TECH_DIR)/generated/${family}/${macro}/VERILOG/$(echo "${macro}" | tr [:upper:] [:lower:])_*_tt0p9v25c.v \$@

\$(OBJ_TECH_DIR)/generated/${family}/${macro}/stamp: src/tools/technology/saed32-mc_run \$(CCOMPILER_BIN) \$(OA2LEF_BIN)
	@mkdir -p \$(dir \$@)
	\$(SCHEDULER_CMD) --max-threads=1 -- \$(abspath \$<) --family ${family} --macro ${macro} --output_dir \$(abspath \$(dir \$@)) \$(abspath \$^)
	date > \$@
EOF
