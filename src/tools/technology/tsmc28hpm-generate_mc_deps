#!/bin/bash

unset output
unset family
unset macro
while [[ "$1" != "" ]]
do
    case "$1" in
    -o) output="$2"; shift;;
    --family) family="$2"; shift;;
    --macro) macro="$2"; shift;;
    *) echo "unknown argument $1"; exit 1;;
    esac
    shift
done

if [[ "$output" == "" ]]
then
    echo "Provide an output file with -o"
    exit 1
fi

cat > "$output" << EOF
# autogenerated by $0
OBJ_MAP_SYN_FILES += \$(OBJ_TECH_DIR)/generated/${family}/${macro}/output/${macro}.lib
\$(OBJ_TECH_DIR)/generated/${family}/${macro}/output/${macro}.lib: \$(OBJ_TECH_DIR)/generated/${family}/${macro}/stamp

OBJ_MAP_SIM_MACRO_FILES += \$(OBJ_TECH_DIR)/generated/${family}/${macro}/output/${macro}.v
\$(OBJ_TECH_DIR)/generated/${family}/${macro}/output/${macro}.v: \$(OBJ_TECH_DIR)/generated/${family}/${macro}/stamp
	@mkdir -p \$(dir \$@)
	cp \$(OBJ_TECH_DIR)/generated/${family}/${macro}/VERILOG/$(echo "${macro}" | tr [:upper:] [:lower:])_*_tt0p9v25c.v \$@

\$(OBJ_TECH_DIR)/generated/${family}/${macro}/stamp: src/tools/technology/tsmc28hpm-run_memory_compiler
	@mkdir -p \$(dir \$@)
	\$(SCHEDULER_CMD) --max-threads=1 -- $< --family ${family} --macro ${macro} --output_dir \$(abspath \$(dir \$@))
	date > \$@
EOF
